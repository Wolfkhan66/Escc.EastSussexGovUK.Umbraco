<?xml version="1.0"?>
<configuration xmlns:xdt="http://schemas.microsoft.com/XML-Document-Transform">
    <!-- There's no command for "insert if missing" so this transform uses a workaround to ensure it'll work on any config file that has at least the root <configuration /> element.
       The workaround is to insert the element you want regardless of whether it's already there, and if there are now two remove the second one. 
       
       The configSections element uses a similar but different workaround from http://stackoverflow.com/questions/18737022/xdt-transform-insertbefore-locator-condition-is-ignored
       which ensures that it's the first child of <configuration />
       -->

  <configSections xdt:Transform="InsertBefore(/configuration/*[1])" />
  <configSections xdt:Locator="XPath(/configuration/configSections[last()])">
    <sectionGroup name="Escc.ClientDependencyFramework" xdt:Transform="Insert" />
    <sectionGroup name="Escc.ClientDependencyFramework" xdt:Transform="Remove" xdt:Locator="XPath(/configuration/configSections/sectionGroup[@name='Escc.ClientDependencyFramework'][2])" />
  </configSections>
  <configSections xdt:Transform="RemoveAll" xdt:Locator="Condition(count(*)=0)" />

  <configSections>
    <sectionGroup name="Escc.ClientDependencyFramework" xdt:Locator="Match(name)">
      <section name="CssFiles" type="System.Configuration.NameValueSectionHandler, System, Version=1.0.5000.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" xdt:Transform="Insert" />
      <section name="CssFiles" xdt:Transform="Remove" xdt:Locator="XPath(/configuration/configSections/sectionGroup[@name='Escc.ClientDependencyFramework']/section[@name='CssFiles'][2])" />
      <section name="ScriptFiles" type="System.Configuration.NameValueSectionHandler, System, Version=1.0.5000.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" xdt:Transform="Insert" />
      <section name="ScriptFiles" xdt:Transform="Remove" xdt:Locator="XPath(/configuration/configSections/sectionGroup[@name='Escc.ClientDependencyFramework']/section[@name='ScriptFiles'][2])" />
    </sectionGroup>
  </configSections>

  <Escc.ClientDependencyFramework xdt:Transform="Insert" />
  <Escc.ClientDependencyFramework xdt:Transform="Remove" xdt:Locator="XPath(/configuration/Escc.ClientDependencyFramework[2])" />

  <Escc.ClientDependencyFramework>
    <CssFiles xdt:Transform="Insert" />
    <CssFiles xdt:Transform="Remove" xdt:Locator="XPath(/configuration/Escc.ClientDependencyFramework/CssFiles[2])" />
    <ScriptFiles xdt:Transform="Insert" />
    <ScriptFiles xdt:Transform="Remove" xdt:Locator="XPath(/configuration/Escc.ClientDependencyFramework/ScriptFiles[2])" />
  </Escc.ClientDependencyFramework>

    <Escc.ClientDependencyFramework>
    <CssFiles>
      <add key="CampaignSmall" xdt:Transform="Remove" xdt:Locator="Match(key)" />
      <add key="CampaignSmall" value="/css/campaigntemplates/campaign-small.css" xdt:Transform="Insert" />
      <add key="CampaignMedium" xdt:Transform="Remove" xdt:Locator="Match(key)" />
      <add key="CampaignMedium" value="/css/campaigntemplates/campaign-medium.css" xdt:Transform="Insert" />
      <add key="CampaignLarge" xdt:Transform="Remove" xdt:Locator="Match(key)" />
      <add key="CampaignLarge" value="/css/campaigntemplates/campaign-large.css" xdt:Transform="Insert" />
      <add key="CampaignPrint" xdt:Transform="Remove" xdt:Locator="Match(key)" />
      <add key="CampaignPrint" value="/css/campaigntemplates/campaign-print.css" xdt:Transform="Insert" />
      <add key="CouncilPlanSmall" xdt:Transform="Remove" xdt:Locator="Match(key)" />
      <add key="CouncilPlanSmall" value="/css/CouncilPlan/council-plan-small.css" xdt:Transform="Insert" />
      <add key="CouncilPlanMedium" xdt:Transform="Remove" xdt:Locator="Match(key)" />
      <add key="CouncilPlanMedium" value="/css/CouncilPlan/council-plan-medium.css" xdt:Transform="Insert" />
      <add key="CouncilPlanLarge" xdt:Transform="Remove" xdt:Locator="Match(key)" />
      <add key="CouncilPlanLarge" value="/css/CouncilPlan/council-plan-large.css" xdt:Transform="Insert" />
      <add key="DownloadSmall" xdt:Transform="Remove" xdt:Locator="Match(key)" />
      <add key="DownloadSmall" value="/css/StandardDownloadPage/download-small.css" xdt:Transform="Insert" />
      <add key="FormDownload" xdt:Transform="Remove" xdt:Locator="Match(key)" />
      <add key="FormDownload" value="/css/FormDownloadPage/form-download.css" xdt:Transform="Insert" />
      <add key="HomeSmall" xdt:Transform="Remove" xdt:Locator="Match(key)" />
      <add key="HomeSmall" value="/css/HomePage/home-small.css" xdt:Transform="Insert" />
      <add key="HomeMedium" xdt:Transform="Remove" xdt:Locator="Match(key)" />
      <add key="HomeMedium" value="/css/HomePage/home-medium.css" xdt:Transform="Insert" />
      <add key="HomeLarge" xdt:Transform="Remove" xdt:Locator="Match(key)" />
      <add key="HomeLarge" value="/css/HomePage/home-large.css" xdt:Transform="Insert" />
      <add key="LandingSmall" xdt:Transform="Remove" xdt:Locator="Match(key)" />
      <add key="LandingSmall" value="/css/StandardLandingPage/landing-small.css" xdt:Transform="Insert" />
      <add key="LandingMedium" xdt:Transform="Remove" xdt:Locator="Match(key)" />
      <add key="LandingMedium" value="/css/StandardLandingPage/landing-medium.css" xdt:Transform="Insert" />
      <add key="TopicSmall" xdt:Transform="Remove" xdt:Locator="Match(key)" />
      <add key="TopicSmall" value="/css/StandardTopicPage/topic-small.css" xdt:Transform="Insert" />
      <add key="TopicMedium" xdt:Transform="Remove" xdt:Locator="Match(key)" />
      <add key="TopicMedium" value="/css/StandardTopicPage/topic-medium.css" xdt:Transform="Insert" />
      <add key="MarriageSkinSmall" xdt:Transform="Remove" xdt:Locator="Match(key)" />
      <add key="MarriageSkinSmall" value="/MarriageSkin/css/min/marriage-skin-small.css" xdt:Transform="Insert" />
      <add key="MarriageSkinMedium" xdt:Transform="Remove" xdt:Locator="Match(key)" />
      <add key="MarriageSkinMedium" value="/MarriageSkin/css/min/marriage-skin-medium.css" xdt:Transform="Insert" />
    </CssFiles>
    <ScriptFiles>
      <add key="CampaignLanding" xdt:Transform="Remove" xdt:Locator="Match(key)" />
      <add key="CampaignLanding" value="/js/campaigntemplates/campaign-landing.js" xdt:Transform="Insert" />
      <add key="CouncilPlan" xdt:Transform="Remove" xdt:Locator="Match(key)" />
      <add key="CouncilPlan" value="/js/CouncilPlan/council-plan.js" xdt:Transform="Insert" />
      <add key="Home" xdt:Transform="Remove" xdt:Locator="Match(key)" />
      <add key="Home" value="/js/HomePage/homepage.js" xdt:Transform="Insert" />
      <add key="HomeTabs" xdt:Transform="Remove" xdt:Locator="Match(key)" />
      <add key="HomeTabs" value="/js/HomePage/jquery-ui-1.10.4.custom.min.js" xdt:Transform="Insert" />
      <add key="MarriageSkin" xdt:Transform="Remove" xdt:Locator="Match(key)" />
      <add key="MarriageSkin" value="/MarriageSkin/js/min/marriage-skin.js" xdt:Transform="Insert" />
    </ScriptFiles>
  </Escc.ClientDependencyFramework>

  <!-- Use HTTP caching on Umbraco pages -->
  <configSections>
    <sectionGroup name="Escc.Umbraco" xdt:Transform="Remove" xdt:Locator="Match(name)" />
    <sectionGroup name="Escc.Umbraco" xdt:Transform="Insert">
      <section name="GeneralSettings" type="System.Configuration.NameValueSectionHandler, System, Version=1.0.5000.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" />
    </sectionGroup>
  </configSections>
  
  <Escc.Umbraco xdt:Transform="Remove" />
  <Escc.Umbraco xdt:Transform="Insert">
    <GeneralSettings>
      <add key="HttpCachingEnabled" value="true" />
    </GeneralSettings>
  </Escc.Umbraco>

  <configSections>
    <sectionGroup name="EsccWebTeam.EastSussexGovUK" xdt:Transform="Remove" xdt:Locator="Match(name)" />
    <sectionGroup name="EsccWebTeam.EastSussexGovUK" xdt:Transform="Insert">
      <section name="GeneralSettings" type="System.Configuration.NameValueSectionHandler, System, Version=1.0.5000.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" />
    </sectionGroup>
  </configSections>

  <EsccWebTeam.EastSussexGovUK xdt:Transform="Remove" />
  <EsccWebTeam.EastSussexGovUK xdt:Transform="Insert">
    <GeneralSettings>
      <add key="MasterPageParameterName" value="template" />
      <add key="DesktopMasterPage" value="~/views/layouts/desktop.cshtml" />
      <add key="FullScreenMasterPage" value="~/views/layouts/fullscreen.cshtml" />
      <add key="PlainMasterPage" value="~/views/layouts/plain.cshtml" />
    </GeneralSettings>
  </EsccWebTeam.EastSussexGovUK>

  <configSections>
    <sectionGroup name="Escc.EastSussexGovUK.Umbraco" xdt:Transform="Remove" xdt:Locator="Match(name)" />
    <sectionGroup name="Escc.EastSussexGovUK.Umbraco" xdt:Transform="Insert">
      <section name="TopicSectionLayouts" type="Escc.EastSussexGovUK.Umbraco.Views.Topic.SectionLayoutConfigurationSection, Escc.EastSussexGovUK.Umbraco" />
    </sectionGroup>
  </configSections>

  <Escc.EastSussexGovUK.Umbraco xdt:Transform="Remove" />
  <Escc.EastSussexGovUK.Umbraco xdt:Transform="Insert">
    <TopicSectionLayouts>
      <SectionLayouts>
        <add name="Normal" displayName="Image on right" displayControl="~/Views/Topic/TopicSection_Normal.ascx" />
        <add name="Alternative" displayName="Image on left" displayControl="~/Views/Topic/TopicSection_Alternative.ascx" />
        <add name="FeaturedImage" displayName="Large image" displayControl="~/Views/Topic/TopicSection_FeaturedImage.ascx" />
        <add name="ImageRowBorderless" displayName="Row of images without borders" displayControl="~/Views/Topic/TopicSection_ImageRowBorderless.ascx" />
        <add name="SchoolClosures" displayName="School closures list" displayControl="~/Views/Topic/TopicSection_SchoolClosures.ascx" />
        <add name="TermDates" displayName="School term dates" displayControl="~/Views/Topic/TopicSection_TermDates.ascx" />
        <add name="FloodAlerts" displayName="Flood alerts (mobile)" displayControl="~/Views/Topic/TopicSection_FloodAlerts.ascx" />
        <add name="RecyclingSiteSearch" displayName="Find a recycling site" displayControl="~/Views/Topic/TopicSection_RecyclingSiteFinder.ascx" />
      </SectionLayouts>
    </TopicSectionLayouts>
  </Escc.EastSussexGovUK.Umbraco>

  <appSettings xdt:Transform="Insert" />
  <appSettings xdt:Transform="Remove" xdt:Locator="XPath(/configuration/appSettings[2])" />

  <appSettings>
    <!-- For flood alerts included on a standard topic page -->
    <add key="FloodAlertsRssUrl" xdt:Transform="Remove" xdt:Locator="Match(key)" />
    <add key="FloodAlertsRssUrl" value="http://www.environment-agency.gov.uk/homeandleisure/floods/134567.aspx" xdt:Transform="Insert"/>

    <add key="Escc.Umbraco.Inception.AuthToken" xdt:Transform="Remove" xdt:Locator="Match(key)" />
    <add key="Escc.Umbraco.Inception.AuthToken" value="" />
  </appSettings>

  <system.web xdt:Transform="Insert" />
  <system.web xdt:Transform="Remove" xdt:Locator="XPath(/configuration/system.web[2])" />

  <system.web>
    <pages xdt:Transform="Insert" />
    <pages xdt:Transform="Remove" xdt:Locator="XPath(/configuration/system.web/pages[2])" />
  </system.web>

  <system.web>
    <pages>
      <controls xdt:Transform="Insert" />
      <controls xdt:Transform="Remove" xdt:Locator="XPath(/configuration/system.web/pages/controls[2])" />
    </pages>
  </system.web>

  <system.web>
    <compilation xdt:Transform="RemoveAttributes(debug)" />

    <globalization xdt:Transform="Remove" />
    <globalization culture="en-GB" uiCulture="en-GB" xdt:Transform="Insert"/>

    <pages>
      <controls>
        <add tagPrefix="CmsPlaceholders" xdt:Transform="Remove" xdt:Locator="Match(tagPrefix)" />
        <add tagPrefix="CmsPlaceholders" namespace="Escc.EastSussexGovUK.Umbraco.MicrosoftCmsMigration.Placeholders" assembly="Escc.EastSussexGovUK.Umbraco" xdt:Transform="Insert" />

        <add tagPrefix="EastSussexGovUK" xdt:Transform="Remove" xdt:Locator="Match(tagPrefix)" />
        <add tagPrefix="EastSussexGovUK" namespace="EsccWebTeam.EastSussexGovUK" assembly="EsccWebTeam.EastSussexGovUK, Version=1.0.0.0, Culture=neutral, PublicKeyToken=06fad7304560ae6f" xdt:Transform="Insert" />
      </controls>
    </pages>
  </system.web>

  <system.webServer xdt:Transform="Insert" />
  <system.webServer xdt:Transform="Remove" xdt:Locator="XPath(/configuration/system.webServer[2])" />

  <system.webServer>
    <handlers xdt:Transform="Insert" />
    <handlers xdt:Transform="Remove" xdt:Locator="XPath(/configuration/system.webServer/handlers[2])" />
    <modules xdt:Transform="Insert" />
    <modules xdt:Transform="Remove" xdt:Locator="XPath(/configuration/system.webServer/modules[2])" />
  </system.webServer>

  <system.webServer>
    <handlers>
      <!-- jsx and cssx are configured at the root because /css and /js are folders within Escc.EastSussexGovUK.Umbraco. Only /css/*.cssx and /css/*.jsx
           requests are routed elsewhere, so putting the config settings in the equivalent folders under Escc.EastSussexGovUK wouldn't work. -->
      <add name="CombineStaticFilesHandlerCss" xdt:Transform="Remove" xdt:Locator="Match(name)" />
      <add verb="GET" path="*.cssx" name="CombineStaticFilesHandlerCss" type="Escc.ClientDependencyFramework.WebForms.CombineStaticFilesHandler, Escc.ClientDependencyFramework.WebForms" xdt:Transform="Insert" />
      <add name="CombineStaticFilesHandlerJs" xdt:Transform="Remove" xdt:Locator="Match(name)" />
      <add verb="GET" path="*.jsx" name="CombineStaticFilesHandlerJs" type="Escc.ClientDependencyFramework.WebForms.CombineStaticFilesHandler, Escc.ClientDependencyFramework.WebForms" xdt:Transform="Insert" />
    </handlers>
    <modules>
      <add name="MicrosoftCmsUrlRedirectionModule" xdt:Transform="Remove" xdt:Locator="Match(name)" />
      <add name="MicrosoftCmsUrlRedirectionModule" type="Escc.EastSussexGovUK.Umbraco.MicrosoftCmsMigration.MicrosoftCmsUrlRedirectionModule, Escc.EastSussexGovUK.Umbraco" xdt:Transform="Insert" />
    </modules>
  </system.webServer>

  <!-- Add C#6 support in Razor views -->
  <system.codedom xdt:Transform="Remove" />
  <system.codedom xdt:Transform="Insert">
    <compilers>
      <compiler language="c#;cs;csharp" extension=".cs" type="Microsoft.CodeDom.Providers.DotNetCompilerPlatform.CSharpCodeProvider, Microsoft.CodeDom.Providers.DotNetCompilerPlatform, Version=1.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35" warningLevel="4" compilerOptions="/langversion:6 /nowarn:1659;1699;1701" />
    </compilers>
  </system.codedom>
</configuration>
